_format_version: "3.0"

services:
  - name: user-service
    url: http://user-service:8000 # Internal Docker network URL
    routes:
      - name: user-service-auth
        paths:
          - /api/v1/user-service/auth
          - /api/v1/user-service/auth/
        strip_path: true
        plugins:
          # Basic rate limiting for all auth endpoints - 100 requests per hour per IP
          - name: rate-limiting
            config:
              hour: 100
              limit_by: ip
              policy: local  # Use local in-memory policy for single instance
      - name: user-service-register
        paths:
          - /api/v1/user-service/auth/register
        strip_path: true
        plugins:
          # More restrictive rate limiting for registration - 5 requests per 15 minutes per IP
          - name: rate-limiting
            config:
              minute: 5
              limit_by: ip
              policy: local
      - name: user-service-otp-request
        paths:
          - /api/v1/user-service/auth/otp/request
        strip_path: true
        plugins:
          # Rate limiting for OTP request endpoint - 3 requests per 5 minutes per IP
          - name: rate-limiting
            config:
              minute: 3
              limit_by: ip
              policy: local
      - name: user-service-login
        paths:
          - /api/v1/user-service/auth/login
        strip_path: true
        plugins:
          # Rate limiting for login endpoint - 10 requests per 15 minutes per IP
          - name: rate-limiting
            config:
              minute: 10
              limit_by: ip
              policy: local
      - name: user-service-profile
        paths:
          - /api/v1/user-service/me
          - /api/v1/user-service/me/
        strip_path: true
        plugins:
          # Rate limiting for profile endpoints - 1000 requests per hour per IP
          - name: rate-limiting
            config:
              hour: 1000
              limit_by: ip
              policy: local
      - name: user-service-family
        paths:
          - /api/v1/user-service/me/family
          - /api/v1/user-service/me/family/
          - /api/v1/user-service/me/family/members
          - /api/v1/user-service/me/family/invite
          - /api/v1/user-service/me/family/transfer
          - /api/v1/user-service/me/family/remove-member
        strip_path: true
        plugins:
          # Rate limiting for family groups endpoints - 100 requests per hour per IP
          - name: rate-limiting
            config:
              hour: 100
              limit_by: ip
              policy: local
      - name: user-service-admin
        paths:
          - /api/v1/user-service/admin
          - /api/v1/user-service/admin/
        strip_path: true
        plugins:
          # Rate limiting for admin endpoints - 500 requests per hour per IP
          - name: rate-limiting
            config:
              hour: 500
              limit_by: ip
              policy: local
    plugins:
      # Global rate limiting for the entire service - 5000 requests per hour per IP
      - name: rate-limiting
        config:
          hour: 5000
          limit_by: ip
          policy: local

# Default rate limiting for all other requests to the API gateway
plugins:
  # Global rate limiting for all requests - 10000 requests per hour per IP
  - name: rate-limiting
    config:
      hour: 10000
      limit_by: ip
      policy: local
    enabled: true